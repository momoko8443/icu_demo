<uku-component>
    <template>
        <div class="pure-g container">
            <div class="pure-u-1 pure-u-md-3-4 main">
                <div class="waiting" uku-render="cc.currentState !== 'inMeeting'">
                    <h1 class="content-subhead">
                        {{cc.message}}
                    </h1>
                    <h1 class="content-subhead">
                        {{cc.message2}}
                    </h1>
                </div>
                
                <div class="videoFrame">
                    <video autoplay="autoplay" playsinline="playsinline" style="height: 100%;width: 100%" id="callerVideo"></video>
                </div>
            </div>
            <div class="pure-u-1 pure-u-md-1-4 sub">
                <div class="pure-g height100">
                    <div class="pure-u-1-2 pure-u-md-1 self">
                        <h1 class="waiting content-subhead" uku-render="cc.loadCamera">
                            <i class="fa fa-circle-o-notch fa-spin"></i>
                            正在开启摄像头...
                        </h1>
                        <div class="videoFrame">
                            <video autoplay="autoplay" playsinline="playsinline" style="height: 100%;width: 100%" id="selfVideo" muted="muted" volume="0"></video>
                        </div>
                    </div>
                    <div class="pure-u-1-2 pure-u-md-1 console">
                        <div class="buttonBox">
                            <div uku-render="cc.currentState ==='standby'">
                                <button type="button" class="pure-button button-success" uku-onclick="cc.call()">
                                    <i class="fa fa-phone fa-lg">{{' 呼叫 ' + cc.otherClientName}}</i>
                                </button>
                            </div>
                            <div uku-render="cc.currentState ==='calling'">
                                <h3 class="post-title">
                                    <i class="fa fa-spinner fa-pulse"></i>
                                    <span>
                                        {{'正在呼叫 '+ cc.otherClientName}}
                                    </span>
                                </h3>
                                <button type="button" class="pure-button button-error" uku-onclick="cc.cancelCall()">
                                    <i class="fa fa-ban fa-lg">
                                        取消呼叫
                                    </i>
                                </button>
                            </div>
                            <div uku-render="cc.currentState==='called'">
                                <h3 class="post-title">
                                    <i class="fa fa-spinner fa-pulse"></i>
                                    <span>
                                        {{'来自 ' + cc.callerName + '呼叫'}}
                                    </span>
                                </h3>
                                <button type="button" class="pure-button button-success" style="margin-top:10px" uku-onclick="cc.accept()">
                                    <i class="fa fa-phone fa-lg">
                                        接听
                                    </i>
                                </button>
                                <button type="button" class="pure-button button-error" style="margin-top:10px" uku-onclick="cc.reject()">
                                    <i class="fa fa-ban fa-lg">
                                        拒绝
                                    </i>
                                </button>
                            </div>
                            <div uku-render="cc.currentState==='inMeeting'">
                                <h2 class="post-title">剩余通话时间</h2>
                                <h2 id="timeleft" class="post-title">{{cc.timeDisplay}}</h2>
                                <button type="button" class="pure-button button-error" uku-onclick="cc.hangUp()">
                                    <i class="fa fa-ban fa-lg">
                                        结束通话
                                    </i>
                                </button>
                            </div>
                        </div>
                        <div class="exitBtn">
                            <i class="fa fa-window-close-o fa-lg" uku-onclick="cc.exit(true)"></i>
                        </div>
                    </div>
                </div>
            </div>
            <audio id="ring" src="demos/mp3/weixin_call.mp3" loop></audio>
        </div>
    </template>
    <script>
        (function (jq) {
            return function (uku) {
                this.message = '';
                this.message2 = '';
                this.loadCamera = true;
                this.currentState = '';
                this.time = 0;
                this.timeDisplay = "";
                this.peer = null;

                var autoExitTimeLeft;
                var selfEasyrtcid = "";
                var callerId = "";
                var self = this;
                var acceptorHandler;
                var config;
                var timerAutoExit;
                var timerCountdown;
                var timerRing;

                this.timeDisplayFunc = function () {
                    var tmp = new Date(this.time);
                    var min = tmp.getMinutes();
                    if (min < 10) {
                        min = '0' + min;
                    }
                    var sec = tmp.getSeconds();
                    if (sec < 10) {
                        sec = '0' + sec;
                    }
                    this.timeDisplay = min + ':' + sec;
                    uku.refresh();
                }

                this.exit = function (e, isActive) {
                    resetFlags(config);
                    var room = self.peer.channel.id;
                    easyrtc.leaveRoom(room);
                    easyrtc.disconnect();
                    this.currentState = "exit";
                    easyrtc.setDisconnectListener(function () {
                        easyrtc.closeLocalMediaStream();
                        self.fire('exitvideochat', {
                            'isActive': isActive
                        });
                    });

                }
                
                this.init = function (peer, cfg) {
                    var room = peer.channel.id;
                    config = cfg;
                    resetFlags(cfg);
                    this.peer = peer;
                    uku.refresh();
                    easyrtc.setVideoDims(720, 720);
                    easyrtc.setUsername(peer.alias);
                    easyrtc.setRoomOccupantListener(roomOccupantHandler);
                    easyrtc.easyApp("easyrtc.audioVideoSimple", "selfVideo", ["callerVideo"],
                        function loginSuccess(easyrtcid) {
                            console.log('login easyrtc Success');
                            selfEasyrtcid = easyrtcid;
                            self.loadCamera = false;
                            easyrtc.joinRoom(room, null, function successCB() {
                                console.log('join room success');
                            }, function failureCB(err) {
                                console.log('join room falied', err);
                            });
                            uku.refresh();
                        },
                        function loginFailure(errorCode, message) {
                            console.log('login easyrtc failed');
                            easyrtc.showError(errorCode, message);
                        });
                    

                    easyrtc.setAcceptChecker(function (easyrtcid, acceptor) {
                        console.log('acceptor ', easyrtcid);
                        self.callerName = easyrtc.idToName(easyrtcid);
                        acceptorHandler = acceptor;
                        self.currentState = 'called';
                        uku.refresh();
                    });
                    easyrtc.setCallCancelled(function (easyrtcid, explicitlyCancelled) {
                        if (explicitlyCancelled) {
                            self.currentState = 'standby';
                            uku.refresh();
                        }
                    });
                    easyrtc.setPeerClosedListener(function () {
                        console.log('PeerClosed');
                        //self.currentState = 'standby';
                        //uku.refresh();
                        self.exit();
                    });
                };

                this.accept = function () {
                    this.currentState = 'inMeeting';
                    acceptorHandler(true);
                    timerCountdown = setInterval(countdown, 1000);
                };
                this.reject = function () {
                    acceptorHandler(false);
                    this.currentState = 'standby';
                };

                this.call = function () {
                    enableCancel = false;
                    if (callerId) {
                        performCall(callerId);
                    }
                    this.currentState = 'calling';
                };

                var initiativelyCancelFlag = false;
                var enableCancel = false;

                this.cancelCall = function () {
                    if(enableCancel){
                        this.fire('cancelcalling');
                        this.currentState = 'standby';
                        initiativelyCancelFlag = true;
                    }      
                }

                this.hangUp = function () {
                    easyrtc.hangupAll();
                    this.currentState = 'standby';
                };

                var _currentState;
                Object.defineProperty(this, 'currentState', {
                    set(value) {
                        _currentState = value;
                        if(_currentState === 'called'){
                            if(timerRing){
                                clearTimeout(timerRing);
                            }
                            timerRing = setTimeout(function(){
                                self.reject();
                                clearTimeout(timerRing);
                            }, config.ringLimitSecond * 1000);
                        }else{
                            if(timerRing){
                                clearTimeout(timerRing);
                            }
                        }
                        if (_currentState === 'calling' || _currentState === 'called') {
                            document.getElementById('ring').play();
                        } else {
                            document.getElementById('ring').pause();
                        }
                        if (_currentState === 'init' || _currentState === 'standby') {
                            //console.log('start timer', timerAutoExit, _currentState);
                            if (timerAutoExit) {
                                clearInterval(timerAutoExit);
                            }
                            if (timerCountdown) {
                                self.time = config.callLimitSecond * 1000;
                                self.timeDisplay = "";
                                clearInterval(timerCountdown);
                            }
                            autoExitTimeLeft = 30;
                            timerAutoExit = setInterval(function () {      
                                self.message = '对方已就绪, 若'+ autoExitTimeLeft +'秒内不发起通话则自动退出';
                                autoExitTimeLeft--;
                                uku.refresh();
                                if(autoExitTimeLeft < 0){
                                    self.exit();
                                }         
                            }, 1000);

                        } else {
                            if (timerAutoExit) {
                                clearInterval(timerAutoExit);
                                //console.log('clear timer', timerAutoExit, _currentState);
                            }
                        }
                        updateMessage(_currentState);
                    },
                    get() {
                        return _currentState;
                    }

                });

                function roomOccupantHandler(roomName, data, isPrimary) {
                    if(roomName !== "default"){
                        var keys = Object.keys(data);
                        if (keys.length === 0) {
                            return;
                        }
                        callerId = keys[0];
                        self.currentState = 'standby';
                        self.otherClientName = easyrtc.idToName(callerId);
                        uku.refresh();
                    }  
                }

                function performCall(otherEasyrtcid) {
                    easyrtc.hangupAll();
                    var successCB = function () {
                        console.log('performCall Success');
                        self.currentState = 'inMeeting';
                        uku.refresh();
                    };
                    var failureCB = function (errorCode, errMessage) {
                        console.log('performCall Failed');
                        console.error(errorCode,errMessage);
                    };
                    var wasAcceptedCB = function (wasAccepted, easyrtcid) {
                        if (wasAccepted) {
                            console.log("call accepted by " + easyrtc.idToName(easyrtcid));
                            self.currentState = 'inMeeting';
                            uku.refresh();
                            timerCountdown = setInterval(countdown, 1000);
                        } else {
                            console.log("call rejected" + easyrtc.idToName(easyrtcid));               
                            self.currentState = 'standby';
                            if(initiativelyCancelFlag){
                                self.message2 = '主动取消呼叫';
                            }else{
                                self.message2 = '对方拒接或长时间呼叫无人应答, 请稍后再拨';
                            }    
                            uku.refresh();
                            setTimeout(function(){
                                self.message2 = '';
                                initiativelyCancelFlag = false;
                                uku.refresh();
                            },5000);
                        }
                    };
                    setTimeout(function(){
                        easyrtc.call(otherEasyrtcid, successCB, failureCB, wasAcceptedCB);
                        enableCancel = true;
                    }, 2000);
                }

                function resetFlags(cfg) {
                    autoExitTimeLeft = cfg.autoExitSecond;
                    self.message = '等待对方加入...';
                    self.message2 = '';
                    self.loadCamera = true;
                    self.currentState = 'init';
                    self.time = cfg.callLimitSecond * 1000;
                    self.timeDisplay = "";
                    selfEasyrtcid = "";
                    callerId = "";
                    jq('#timeleft').removeClass('six_zero_sec_left');
                    if (timerAutoExit) {
                        clearTimeout(timerAutoExit);
                    }
                    if (timerCountdown) {
                        clearInterval(timerCountdown);
                    }
                }

                function countdown() {
                    self.time -= 1000;
                    self.timeDisplayFunc();
                    if (self.time === 60 * 1000) {
                        jq('#timeleft').addClass('six_zero_sec_left');
                    }
                    if (self.time === 0) {
                        clearInterval(timerCountdown);
                        self.exit();
                    }
                }
                function updateMessage(state){
                    
                    switch(state){
                        case 'init':
                            self.message = '等待对方加入...';
                            break;
                        case 'standby':
                            self.message = '对方已就绪, 若' + autoExitTimeLeft + '秒内不发起通话则自动退出';
                            break;
                        case 'calling':
                            self.message = '呼叫中...';
                            break;
                        case 'called':
                            self.message = '被呼叫中..., 请接听或拒绝';
                            break;
                        case 'inMeeting':
                            self.message = '通话中...';
                            break;
                        case 'exit': 
                            self.message = '正在退出...';
                            break;
                        default:
                            self.message = '等待对方加入...';
                    }
                    uku.refresh();
                }
            }
        })($)
    </script>
</uku-component>