<!DOCTYPE html>

<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="pragma" content="no-cache">
    <title>ICU RTC</title>
    <link rel="icon" sizes="192x192" href="demos/images/icu/icon.png">
    <link rel="shortcut icon" href="demos/favicon/favicon.ico" >
    <link rel="icon" type="image/gif" href="demos/favicon/animated_favicon1.gif" >
    <link rel="stylesheet" href="demos/css/purecss/pure-min.css">
    <link rel="stylesheet" href="demos/css/purecss/grids-responsive-min.css">
    <link rel="stylesheet" href="demos/css/animate/animate.css">
    <link rel="stylesheet" href="demos/css/main.css">
    <link rel="stylesheet" href="demos/css/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="demos/css/bootstrap/css/bootstrap.min.css">
    <script src="demos/js/socket.io/socket.io.min.js"></script>
    <!-- <script src="demos/js/uku-routejs/build/js/uku-route.js"></script> -->
    <script src="demos/js/ukulele/uku.js"></script>
    <script src="demos/js/jquery/jquery-3.3.1.min.js"></script>
    <script src="demos/js/jq.animate.plugin.js"></script>
    <script src="demos/js/axios/axios.min.js"></script>
    <script src="demos/css/bootstrap/js/bootstrap.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/easyrtc/labs/easyrtc_rates.js"></script>

</head>
<body uku-application style="height: 100%;background-color: darkslategrey;visibility: hidden">
    <welcome id="welcome" uku-render="appCtrl.currentStage === 'welcome'" 
        uku-onentersettings="appCtrl.enterSettingHandler()"
        uku-onenterevent="appCtrl.enterEventHandler()"></welcome>
    <login id="login" uku-render="appCtrl.currentStage === 'login'" 
        uku-onloginsuccessevent="appCtrl.loginSuccessEventHandler()"
        uku-oncancellogin="appCtrl.cancelLoginHandler()"></login>
    <choose-client id="chooseClient" uku-render="appCtrl.currentStage === 'chooseClient'"
        uku-onsettingssaved="appCtrl.settingsSavedHandler()"
        uku-oncancelchooseclient="appCtrl.cancelChooseClientHandler()"></choose-client>
    <unbind-client id="unbindClient" uku-render="appCtrl.currentStage === 'unbindClient'"
        uku-client="appCtrl.client"
        uku-onsettingsdeleted="appCtrl.settingsDeletedHandler()"
        uku-oncancelexitchannel="appCtrl.cancelExitChannelHandler()">
    </unbind-client>
    <standby id="standby" uku-render="appCtrl.currentStage === 'standby'" 
        uku-onjoinroom="appCtrl.joinRoomHandler()"
        uku-onexitstandy="appCtrl.exitStandby()">
    </standby>
    <video-chat id="videoChat" uku-render="appCtrl.currentStage === 'videoChat'"
        uku-oncancelcalling="appCtrl.cancelcallingHandler()"
        uku-onexitvideochat="appCtrl.exitVideoChatHandler()"
        uku-onhangupcall="appCtrl.hangUpCallHandler()"></video-chat>
    <audio id="ring" volume="0.9" src="demos/mp3/weixin_call.mp3" loop></audio>
    <audio id="warning" volume="0.9" src="demos/mp3/warning-audio.mp3"></audio>
    <!-- <div id="debug">
        
    </div> -->

</body>
<script>
    var uku = new Ukulele();
    var appCtrl = new ApplicationController(uku);
    uku.registerComponent('welcome','demos/components/welcome.html');
    uku.registerComponent('login','demos/components/login.html');
    uku.registerComponent('choose-client','demos/components/chooseClient.html');
    uku.registerComponent('standby','demos/components/standby.html');
    uku.registerComponent('unbind-client','demos/components/unbindClient.html');
    uku.registerComponent('video-chat','demos/components/videoChat.html');
    uku.registerController('appCtrl', appCtrl);
    uku.init();
    uku.addListener(Ukulele.INITIALIZED, function () {
        appCtrl.init();
    });

    function ApplicationController(uku) {
        var self = this;
        
        this.currentStage = "welcome";
        this.client = {};
        var isRegister = false;
        var socket;
        var welcomePage;
        var loginPage;
        var chooseClientPage;
        var unbindClientPage;
        var videoChatPage;
        var standbyPage;
        var currentTarget;

        this.init = function(){
            welcomePage = document.getElementById('welcome');
            loginPage = document.getElementById('login');
            chooseClientPage = document.getElementById('chooseClient');
            unbindClientPage = document.getElementById('unbindClient');
            standbyPage = document.getElementById('standby');
            videoChatPage = document.getElementById('videoChat');
            
            if(localStorage.getItem('client')){
                isRegister = true;
                try{
                    this.client = JSON.parse(localStorage.getItem('client'));
                    if(!this.client){
                        alert('未能读取节点配置信息');
                        return;
                    }
                }catch(e){
                    alert(JSON.stringify(e));
                    return;
                }
                
                socket = io(location.href);
                socket.on('client_connected', function (data) {
                    console.log(data);
                    console.log('connected socket server');
                    socket.emit('client_info',{clientId:self.client.clientId});
                    //socket.emit('join_room', { room: self.peer.channel.id });
                });

                socket.on('peer_exit',function(data){
                    if(self.currentStage === 'videoChat'){
                        var videoChatInstance = uku.getComponentController('videoChat');
                        videoChatInstance.exit();
                    }  
                });
                socket.on('cancel_calling',function(data){
                    if(self.currentStage === 'videoChat'){
                        var videoChatInstance = uku.getComponentController('videoChat');
                        videoChatInstance.reject();
                    }
                });
                socket.on('refreshAllClient',function(data){
                    console.log(data);
                    location.reload();
                });
                socket.on('hangup_call', function(data){
                    if(self.currentStage === 'videoChat'){
                        alert('被挂断!');
                        var videoChatInstance = uku.getComponentController('videoChat');
                        videoChatInstance.beHangUp();
                    } 
                });
            }

            this.enterSettingHandler = function(){
                switchView(welcomePage,loginPage);
            };
            this.enterEventHandler = function(e, callback){
                if(isRegister){
                        switchView(e.currentTarget,standbyPage,function(){
                            var standbyInstance = uku.getComponentController('standby');
                            standbyInstance.init(socket);
                            callback && callback();
                        })
                    
                }else{
                    switchView(e.currentTarget, loginPage, function(){
                        callback && callback();
                    });
                }
            }

            this.loginSuccessEventHandler = function(e){
                if(isRegister){
                    switchView(e.currentTarget,unbindClientPage);
                }else{
                    switchView(e.currentTarget,chooseClientPage,function(){
                        var chooseClientInstance = uku.getComponentController('chooseClient');
                        chooseClientInstance.init();
                    });
                }
            };
            this.cancelLoginHandler = function(e){
                switchView(e.currentTarget,welcomePage);
            };

            this.settingsSavedHandler = function(){
                location.reload();
            };
            this.settingsDeletedHandler = function(){
                location.reload();
            };

            this.cancelChooseClientHandler = function(e){
                switchView(e.currentTarget,welcomePage);
            };
            this.cancelExitChannelHandler = function(e){
                switchView(e.currentTarget,welcomePage);
            };
            this.exitVideoChatHandler = function(e){
                let room = e.data.room;
                switchView(e.currentTarget,standbyPage,function(){
                    socket.emit('peer_exit',{ "room": room});                 
                });
                location.reload();
            };
            this.cancelcallingHandler = function(e){
                let room = e.data.room;
                socket.emit('cancel_calling',{"room": room });
            };
            this.hangUpCallHandler = function(e){
                let room = e.data.room;
                socket.emit('hangup_call',{ "room": room});
                // switchView(e.currentTarget,standbyPage,function(){
                //     var standbyInstance = uku.getComponentController('standby');
                //     standbyInstance.init(socket);
                // });
                location.reload();
            };

            this.joinRoomHandler = function(e){
                var room = e.data.room;
                switchView(e.currentTarget,videoChatPage,function(){
                    var videoChatInstance = uku.getComponentController('videoChat');
                    videoChatInstance.init(room,vidoeChatCfg);
                });
            };
            this.exitStandby = function(e){
                switchView(e.currentTarget,welcomePage);
            };
            var vidoeChatCfg;
            getCfg().then(function(result){
                //console.log(result);
                vidoeChatCfg = result;
                self.enterEventHandler({currentTarget:welcomePage}, function(){
                    $('body').css('visibility','visible');
                });
                
            });

            function switchView(oldView,newView,callback){
                $(oldView).animateCss('fadeOut', function(){
                    self.currentStage = newView.id;
                    currentTarget = newView;
                    uku.refresh();
                    $(newView).animateCss('fadeIn');
                    if(callback && typeof callback === 'function'){
                        callback();
                    }
                })
            }

            function getCfg(){
                return axios.get('/config').then(function(result){
                    return result.data;
                }).catch(function(err){
                    alert(err);
                });
            }
        }
    }
</script>
</html>